#
# $FreeBSD: src/tools/tools/nanobsd/rescue/common,v 1.1.2.1.2.1 2009/10/25 01:10:29 kensmith Exp $
#
NANO_TOOLS=`pwd`
NANO_PACKAGE_DIR=`pwd`/Pkg
NANO_RAM_TMPVARSIZE=20480
NANO_PMAKE="make -j 8"


CONF_BUILD='
NO_KLDLOAD=YES
WITHOUT_PAM=YES
'

CONF_INSTALL='
NO_ACPI=YES
NO_BLUETOOTH=YES
NO_CVS=YES
NO_FORTRAN=YES
NO_HTML=YES
NO_LPR=YES
NO_MAN=YES
NO_SENDMAIL=YES
NO_SHAREDOCS=YES
NO_EXAMPLES=YES
NO_INSTALLLIB=YES
NO_CALENDAR=YES
NO_MISC=YES
NO_SHARE=YES
'

CONF_WORLD='
CFLAGS=-O -pipe
NO_BIND=YES
NO_MODULES=YES
NO_KERBEROS=YES
NO_GAMES=YES
NO_RESCUE=YES
NO_LOCALES=YES
NO_SYSCONS=YES
NO_INFO=YES
'

#customize_cmd cust_comconsole
customize_cmd cust_allow_ssh_root

cust_nobeastie() (
    touch ${NANO_WORLDDIR}/boot/loader.conf
    echo "beastie_disable=\"YES\"" >> ${NANO_WORLDDIR}/boot/loader.conf
    echo "autoboot_delay=\"-1\"" >> ${NANO_WORLDDIR}/boot/loader.conf
 
)

customize_cmd cust_nobeastie

customize_cmd cust_pkg

customize_cmd remove_non_mono_files

customize_cmd cust_install_files

cust_etc_cfg () (
  cd ${NANO_WORLDDIR}
#  mkdir -pv scratch
	echo "hostname=\"M0n0wall\"" > etc/rc.conf
	echo "#ifconfig_fxp0=\"AUTO\"" >> etc/rc.conf
	echo "#sshd_enable=\"YES\"" >> etc/rc.conf
	echo "/dev/acd0 / cd9660 ro 0 0" > etc/fstab
	echo "tmpfs /tmp tmpfs rw,size=268435456,mode=1777 0 0" >> etc/fstab
	echo "ports:/usr/ports /usr/ports nfs rw,noauto,noatime,bg,soft,intr,nfsv3 0 0" >> etc/fstab
#	echo "/dev/ad1s1a /scratch ufs rw,noauto,noatime 0 0" >> etc/fstab
	/usr/sbin/pwd_mkdb -d etc etc/master.passwd
)
customize_cmd cust_etc_cfg

setup_nanobsd_etc ( ) (
	pprint 2 "configure nanobsd /etc"
	(
	cd ${NANO_WORLDDIR}
	# create diskless marker file
	touch etc/diskless
	# Make root filesystem R/O by default
	echo "root_rw_mount=NO" >> etc/defaults/rc.conf
	# save config file for scripts
	echo "NANO_DRIVE=${NANO_DRIVE}" > etc/nanobsd.conf
	mkdir -p cfg
	)
)
remove_non_mono_files () {
	pprint 2 "Removing non M0n0 Files"
	rm ${NANO_WORLDDIR}/usr/local/etc/rc.d/*
	rm ${NANO_WORLDDIR}/etc/rc.sendmail
	rm ${NANO_WORLDDIR}/etc/rc.d/*

}

last_orders () (
	pprint 2 "last orders"
	(
	cd ${NANO_WORLDDIR}
	rm -f conf/default/etc/remount
	touch conf/default/etc/.keepme
	touch conf/default/var/.keepme
	cd ..
	mkisofs -quiet -r -J -no-emul-boot -b boot/cdboot -o _.disk.iso _.w/
	)
)

